# 流式传输实现详解

## 概述

NeuInk 系统中的流式传输主要用于文本解析过程，能够实时显示解析进度，提升用户体验。当用户提交文本进行解析时，后台通过 Server-Sent Events (SSE) 将解析进度实时推送到前端，前端通过 EventSource API 接收并展示这些更新。

## 后端实现

### 路由定义

流式传输功能主要通过以下两个端点实现：

1. **用户论文解析**：`/api/v1/user_papers/<entry_id>/sections/<section_id>/add-block-from-text-stream`
2. **管理员论文解析**：`/api/v1/admin_papers/<paper_id>/sections/<section_id>/add-block-from-text-stream`

这两个端点都使用 GET 方法，接收以下参数：
- `text`: 需要解析的文本内容
- `afterBlockId`: 指定插入位置的 block ID（可选）
- `sessionId`: 会话ID，用于恢复连接（可选）

### 关键实现

#### 1. 会话管理

后端使用 `parsingSession` 模型来管理解析会话，会话包含以下关键信息：
- `sessionId`: 唯一会话ID
- `userId`: 发起请求的用户ID
- `paperId`: 目标论文ID
- `sectionId`: 目标章节ID
- `text`: 待解析文本
- `status`: 会话状态（pending/processing/completed/failed）
- `progress`: 解析进度（0-100）
- `message`: 当前状态消息
- `progressBlockId`: 进度块ID（用于在前端显示解析进度）

#### 2. 进度块

解析过程中，后端会在目标章节插入一个特殊类型的 block（type="loading"）来显示解析进度。这个进度块包含：
- 当前状态（pending/processing/completed/failed）
- 进度百分比
- 状态消息
- 原始文本内容
- 会话ID

#### 3. 后台任务

解析过程是在后台异步执行的，使用了 `background_tasks` 模块进行任务管理。解析流程包括：
1. 预处理和初始化
2. 调用 LLM 解析文本（流式输出）
3. 处理解析结果
4. 更新论文数据
5. 完成会话

#### 4. 流式响应

后端使用 Flask 的 `Response` 类与 `generate()` 函数生成 SSE 响应：

```python
def generate():
    # 定期检查任务状态
    while True:
        current_task = task_manager.get_task(session_id)
        
        # 检查任务状态并发送相应更新
        if current_task.status.value == "completed":
            # 获取完成的会话数据
            yield f"data: {json.dumps({'type': 'status_update', 'data': {'status': 'completed', 'progress': 100, 'message': '解析完成', 'paper': completed_session.get('paperData'), 'sessionId': session_id}}, ensure_ascii=False)}\n\n"
            break
        elif current_task.status.value == "failed":
            # 发送错误信息
            yield f"data: {json.dumps({'type': 'status_update', 'data': {'status': 'failed', 'progress': 0, 'message': current_task.error or '任务失败', 'error': current_task.error or '任务失败', 'sessionId': session_id}}, ensure_ascii=False)}\n\n"
            break
        else:
            # 发送进度更新
            yield f"data: {json.dumps({'type': 'status_update', 'data': {'status': 'processing', 'progress': current_task.progress, 'message': current_task.message, 'sessionId': session_id}}, ensure_ascii=False)}\n\n"
        
        # 等待一段时间再检查
        time.sleep(0.5)
```

#### 5. LLM 解析

LLM 解析是流式传输的核心部分，使用了 `llm_utils.py` 中的 `parse_text_to_blocks_stream` 方法：

```python
def parse_text_to_blocks_stream(self, text: str, section_context: str = ""):
    # 生成器函数，逐块返回解析结果
    
    # 步骤1：解析Markdown
    blocks = yield from _parse_markdown_stream()
    if blocks is None:
        return
    
    # 步骤2：添加翻译
    blocks = yield from _add_translations_stream(blocks)
    if blocks is None:
        return
    
    # 步骤3：修复和验证
    validated_blocks = yield from _fix_and_validate_stream(blocks)
    if validated_blocks is None:
        return
    
    # 完成
    yield {"type": "complete", "message": f"解析完成，共生成 {len(validated_blocks)} 个内容块", "blocks": validated_blocks, "progress": 100}
```

每个步骤都通过 yield 语句实时推送进度更新。

### 关键代码位置

- 后端路由：`apps/api/neuink/routes/user_papers.py` 和 `apps/api/neuink/routes/admin_papers.py`
- LLM 工具类：`apps/api/neuink/utils/llm_utils.py`
- 会话模型：`apps/api/neuink/models/parsingSession.py`
- 后台任务管理：`apps/api/neuink/utils/background_tasks.py`

## 前端实现

### ParseProgressModal 组件

前端主要通过 `ParseProgressModal.tsx` 组件实现流式传输功能，该组件负责：
1. 建立与管理 EventSource 连接
2. 接收并处理来自后端的 SSE 事件
3. 更新 UI 显示解析进度
4. 处理错误和重连

### 关键实现

#### 1. 建立连接

前端使用浏览器的 `EventSource` API 建立与后端的 SSE 连接：

```typescript
const connectToStream = () => {
    // 构建SSE URL
    const baseUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000';
    const streamUrl = `${baseUrl}/api/v1/stream/parsing-stream/${paperId}/${sectionId}/${blockId}`;
    
    const eventSource = new EventSource(streamUrl, {
        withCredentials: true
    });
    
    // 设置事件处理函数
    eventSource.onopen = () => {
        // 连接建立后的处理
    };
    
    eventSource.onmessage = (event) => {
        // 接收消息并更新UI
        const data = JSON.parse(event.data);
        // 更新进度、状态和消息
    };
    
    eventSource.onerror = (error) => {
        // 连接错误处理，包括自动重连
        setTimeout(() => {
            connectToStream();
        }, 5000); // 5秒后重连
    };
    
    eventSourceRef.current = eventSource;
};
```

#### 2. 消息处理

前端解析从后端接收到的 SSE 事件，并根据类型更新界面：

```typescript
eventSource.onmessage = (event) => {
    try {
        const data = JSON.parse(event.data);
        
        if (data.type === 'status_update') {
            const statusData = data.data;
            setProgress(statusData);
            
            // 如果解析完成，调用回调
            if (statusData.status === 'completed') {
                onCompleted(statusData);
                setTimeout(() => {
                    onClose();
                }, 2000);
            }
            // 如果解析失败，显示错误
            else if (statusData.status === 'failed') {
                console.error('❌ 解析失败:', statusData.message);
            }
        } else if (data.type === 'error') {
            console.error('❌ 流式传输错误:', data.message);
            // 更新错误状态
        }
    } catch (error) {
        console.error('解析数据失败:', error);
    }
};
```

#### 3. 自动重连

前端实现了自动重连机制，在连接中断时自动尝试重新连接（通过在 `onerror` 事件处理中添加重连代码）。

### 关键代码位置

- 前端组件：`apps/web/src/components/paper/ParseProgressModal.tsx`

## 交互流程

1. 用户在前端发起文本解析请求
2. 后端创建会话和进度块，返回会话ID
3. 前端建立与后端的 SSE 连接，传递会话ID
4. 后端启动后台任务执行文本解析
5. 后台任务定期更新进度状态
6. 后端通过 SSE 将进度状态推送给前端
7. 前端接收进度更新并更新界面显示
8. 解析完成后，后端发送完成消息并更新论文数据
9. 前端收到完成消息，关闭进度对话框并更新论文显示

## 扩展功能

流式传输系统还支持会话恢复功能，如果连接中断，用户可以通过会话ID重新建立连接并恢复解析进度。此外，系统还提供了查询、删除解析会话的API，以进一步增强用户体验。

## 总结

流式传输是 NeuInk 系统中的重要功能，通过 SSE 和 EventSource 实现前后端实时通信，提高了用户交互体验。通过后台任务管理、进度块显示和自动重连等机制，确保了解析过程的稳定性和用户体验的连贯性。