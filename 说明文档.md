# 论文阅读与共享网站 - 后端需求文档

## 一、系统概述

NeuInk是一个论文阅读与共享平台，提供论文的数字化管理和阅读体验。系统采用前后端分离架构，后端基于FastAPI框架，前端基于Next.js框架。

### 1.1 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Web Frontend  │    │   API Backend   │    │     MongoDB     │
│   (Next.js)     │◄──►│   (FastAPI)     │◄──►│   Database      │
│                 │    │                 │    │                 │
│ - 论文浏览      │    │ - 用户认证      │    │ - User          │
│ - 个人论文库    │    │ - 论文管理      │    │ - Paper         │
│ - 笔记管理      │    │ - 笔记系统      │    │ - UserPaper     │
│ - 清单管理      │    │ - 文件上传      │    │ - Note          │
│                 │    │                 │    │ - Checklist     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 1.2 技术栈

- **后端**: FastAPI, MongoDB, JWT认证
- **前端**: Next.js, TypeScript, Tailwind CSS
- **文件存储**: 本地文件系统
- **AI解析**: 大模型API (待集成)

## 二、核心概念

- **管理员**: 特殊账号（username=admin），负责维护公开论文库
- **普通用户**: 注册用户，可浏览公开论文、管理个人论文库
- **公开论文**: 管理员创建，所有用户可见，仅管理员可编辑
- **私有论文**: 用户创建，仅自己可见可编辑
- **个人论文库**: 用户收藏的论文集合（来自公开库+私有论文）
- **清单**: 用户创建的论文分类管理工具，可包含个人库中的论文
- **笔记**: 关联到论文Block的私有内容，分为两种：
  - **Block笔记**: 针对论文具体内容的笔记
  - **清单笔记**: 描述论文与清单关系的笔记

---

## 三、数据模型

### User (用户)
```typescript
{
  id: string
  username: string        // 唯一登录账号
  password: string        // 明文存储（生产环境应加密）
  nickname: string        // 昵称
  role: "admin" | "user"  // 角色
  createdAt: Date
  updatedAt: Date
}
```

### Paper (论文)
```typescript
{
  id: string
  isPublic: boolean       // true=公开论文, false=私有论文
  createdBy: string       // 创建者用户ID

  // 元数据
  metadata: {
    title: string         // 英文标题
    titleZh?: string      // 中文标题
    shortTitle?: string
    authors: Array<{
      name: string
      affiliation?: string
      email?: string
    }>
    publication?: string
    year?: number
    date?: string
    doi?: string
    articleType?: 'journal' | 'conference' | 'preprint' | 'book' | 'thesis'
    sciQuartile?: '无' | 'Q1' | 'Q2' | 'Q3' | 'Q4'
    casQuartile?: '无' | '1区' | '2区' | '3区' | '4区'
    ccfRank?: '无' | 'A' | 'B' | 'C'
    impactFactor?: number
    tags?: string[]
  }

  abstract?: {
    en?: string
    zh?: string
  }

  keywords?: string[]

  // 章节内容
  sections: Array<{
    id: string
    number?: string
    title: {
      en?: string
      zh?: string
    }
    content: BlockContent[]    // 见下方Block类型定义
    subsections?: Section[]    // 递归子章节
  }>

  // 参考文献
  references: Array<{
    id: string
    number?: number
    authors: string[]
    title: string
    publication?: string
    year?: number
    doi?: string
    url?: string
    pages?: string
    volume?: string
    issue?: string
  }>

  // 附件
  attachments: {
    pdf?: string             // PDF文件路径
    markdown?: string        // Markdown文件路径
  }

  // 解析状态
  parseStatus: {
    status: 'pending' | 'parsing' | 'completed' | 'failed'
    progress: number         // 0-100
    message: string          // 进度描述
  }

  createdAt: Date
  updatedAt: Date
}
```

### UserPaper (用户-论文关联)
```typescript
{
  id: string
  userId: string
  paperId: string
  addedAt: Date

  // 个性化数据
  readingStatus?: 'unread' | 'reading' | 'finished'
  priority?: 'high' | 'medium' | 'low'
  remarks?: string           // 个人备注
  readingPosition?: number   // 阅读位置（Block索引）
  totalReadingTime?: number  // 总阅读时长（秒）
  lastReadTime?: Date
}
```

### Checklist (清单)
```typescript
{
  id: string
  userId: string
  name: string              // 清单名称，如"时间序列-缺陷检测"
  description?: string      // 清单描述
  createdAt: Date
  updatedAt: Date
}
```

### ChecklistItem (清单项目)
```typescript
{
  id: string
  checklistId: string
  paperId: string
  addedAt: Date
  order?: number           // 在清单中的排序
}
```

### Note (笔记)
```typescript
{
  id: string
  userId: string
  paperId: string
  blockId?: string         // Block笔记：关联的Block ID
  checklistId?: string     // 清单笔记：关联的清单ID
  content: InlineContent[] // 笔记内容
  tags?: string[]
  createdAt: Date
  updatedAt: Date
}
```

### BlockContent 类型定义

#### 内联元素 (InlineContent)
```typescript
// 纯文本
TextNode: {
  type: 'text'
  content: string
  style?: {
    bold?: boolean
    italic?: boolean
    underline?: boolean
    strikethrough?: boolean
    code?: boolean
    color?: string
    backgroundColor?: string
  }
}

// 超链接
LinkNode: {
  type: 'link'
  url: string
  children: InlineContent[]
  title?: string
}

// 行内数学公式
InlineMathNode: {
  type: 'inline-math'
  latex: string
}

// 文献引用
CitationNode: {
  type: 'citation'
  referenceIds: string[]
  displayText: string
}

// 图表引用
FigureRefNode: {
  type: 'figure-ref'
  figureId: string
  displayText: string
}

TableRefNode: {
  type: 'table-ref'
  tableId: string
  displayText: string
}

// 章节引用
SectionRefNode: {
  type: 'section-ref'
  sectionId: string
  displayText: string
}

// 公式引用
EquationRefNode: {
  type: 'equation-ref'
  equationId: string
  displayText: string
}

// 脚注
FootnoteNode: {
  type: 'footnote'
  id: string
  content: string
  displayText: string
}
```

#### 块级元素 (BlockContent)
```typescript
// 标题
HeadingBlock: {
  id: string
  type: 'heading'
  level: 1 | 2 | 3 | 4 | 5 | 6
  content: {
    en?: InlineContent[]
    zh?: InlineContent[]
  }
  number?: string
}

// 段落
ParagraphBlock: {
  id: string
  type: 'paragraph'
  content: {
    en?: InlineContent[]
    zh?: InlineContent[]
  }
  align?: 'left' | 'center' | 'right' | 'justify'
}

// 数学公式
MathBlock: {
  id: string
  type: 'math'
  latex: string
  label?: string
  number?: number
}

// 图片
FigureBlock: {
  id: string
  type: 'figure'
  src: string
  alt?: string
  number?: number
  caption: {
    en?: InlineContent[]
    zh?: InlineContent[]
  }
  description?: {
    en?: InlineContent[]
    zh?: InlineContent[]
  }
  width?: string
  height?: string
  uploadedFilename?: string
}

// 表格
TableBlock: {
  id: string
  type: 'table'
  number?: number
  caption: {
    en?: InlineContent[]
    zh?: InlineContent[]
  }
  description?: {
    en?: InlineContent[]
    zh?: InlineContent[]
  }
  headers?: string[]
  rows: (string | { en?: string; zh?: string })[][]
  align?: ('left' | 'center' | 'right')[]
}

// 代码块
CodeBlock: {
  id: string
  type: 'code'
  language?: string
  code: string
  caption?: {
    en?: InlineContent[]
    zh?: InlineContent[]
  }
  showLineNumbers?: boolean
}

// 有序列表
OrderedListBlock: {
  id: string
  type: 'ordered-list'
  items: Array<{
    content: {
      en?: InlineContent[]
      zh?: InlineContent[]
    }
  }>
  start?: number
}

// 无序列表
UnorderedListBlock: {
  id: string
  type: 'unordered-list'
  items: Array<{
    content: {
      en?: InlineContent[]
      zh?: InlineContent[]
    }
  }>
}

// 引用块
QuoteBlock: {
  id: string
  type: 'quote'
  content: {
    en?: InlineContent[]
    zh?: InlineContent[]
  }
  author?: string
}

// 分隔线
DividerBlock: {
  id: string
  type: 'divider'
}
```

---

## 四、功能模块

### 模块1：用户系统

#### 1.1 用户认证

##### 1.1.1 用户登录
- **接口**: `POST /api/v1/users/login`
- **描述**: 验证用户名密码，返回JWT token和用户基本信息
- **请求参数**:
  ```json
  {
    "username": "string",
    "password": "string"
  }
  ```
- **响应数据**:
  ```json
  {
    "code": 200,
    "message": "登录成功",
    "data": {
      "token": "JWT_TOKEN_STRING",
      "user": {
        "id": "user_id",
        "username": "username",
        "nickname": "用户昵称",
        "role": "user",
        "createdAt": "2023-01-01T00:00:00.000Z",
        "updatedAt": "2023-01-01T00:00:00.000Z"
      }
    }
  }
  ```

##### 1.1.2 获取当前用户信息
- **接口**: `GET /api/v1/users/current`
- **描述**: 根据token返回当前登录用户的详细信息
- **认证**: 需要Bearer Token
- **响应数据**:
  ```json
  {
    "code": 200,
    "message": "操作成功",
    "data": {
      "id": "user_id",
      "username": "username",
      "nickname": "用户昵称",
      "role": "user",
      "createdAt": "2023-01-01T00:00:00.000Z",
      "updatedAt": "2023-01-01T00:00:00.000Z"
    }
  }
  ```

##### 1.1.3 用户登出
- **接口**: `POST /api/v1/users/logout`
- **描述**: 清除token或标记token失效
- **认证**: 需要Bearer Token
- **响应数据**:
  ```json
  {
    "code": 200,
    "message": "登出成功",
    "data": null
  }
  ```

#### 1.2 用户管理（仅管理员）

##### 1.2.1 创建新用户
- **接口**: `POST /api/v1/users/`
- **描述**: 管理员手动创建用户账号
- **认证**: 需要管理员权限
- **请求参数**:
  ```json
  {
    "username": "string",
    "password": "string",
    "nickname": "string",
    "role": "user"
  }
  ```
- **响应数据**:
  ```json
  {
    "code": 201,
    "message": "用户创建成功",
    "data": {
      "id": "user_id",
      "username": "username",
      "nickname": "用户昵称",
      "role": "user",
      "createdAt": "2023-01-01T00:00:00.000Z",
      "updatedAt": "2023-01-01T00:00:00.000Z"
    }
  }
  ```

##### 1.2.2 获取用户列表
- **接口**: `GET /api/v1/users/`
- **描述**: 获取所有用户列表，支持分页和搜索
- **认证**: 需要管理员权限
- **查询参数**:
  - `page`: 页码，默认1
  - `limit`: 每页数量，默认10，最大100
  - `keyword`: 搜索关键词（匹配用户名或昵称）
- **响应数据**:
  ```json
  {
    "code": 200,
    "message": "操作成功",
    "data": {
      "users": [
        {
          "id": "user_id",
          "username": "username",
          "nickname": "用户昵称",
          "role": "user",
          "createdAt": "2023-01-01T00:00:00.000Z",
          "updatedAt": "2023-01-01T00:00:00.000Z"
        }
      ],
      "pagination": {
        "page": 1,
        "limit": 10,
        "total": 100,
        "pages": 10
      }
    }
  }
  ```

##### 1.2.3 获取指定用户信息
- **接口**: `GET /api/v1/users/{user_id}`
- **描述**: 获取指定用户的详细信息
- **认证**: 需要管理员权限
- **响应数据**: 同获取当前用户信息

##### 1.2.4 更新用户信息
- **接口**: `PUT /api/v1/users/{user_id}`
- **描述**: 更新指定用户的信息
- **认证**: 需要管理员权限
- **请求参数**:
  ```json
  {
    "nickname": "新昵称",
    "password": "新密码",
    "role": "user"
  }
  ```
- **响应数据**: 返回更新后的用户信息

##### 1.2.5 删除用户
- **接口**: `DELETE /api/v1/users/{user_id}`
- **描述**: 删除指定用户（不能删除管理员账号）
- **认证**: 需要管理员权限
- **响应数据**:
  ```json
  {
    "code": 200,
    "message": "用户删除成功",
    "data": null
  }
  ```

#### 1.3 个人资料管理

##### 1.3.1 更新个人资料
- **接口**: `PUT /api/v1/users/profile`
- **描述**: 用户更新自己的个人资料
- **认证**: 需要Bearer Token
- **请求参数**:
  ```json
  {
    "nickname": "新昵称"
  }
  ```
- **响应数据**: 返回更新后的用户信息

##### 1.3.2 修改密码
- **接口**: `PUT /api/v1/users/password`
- **描述**: 用户修改自己的密码
- **认证**: 需要Bearer Token
- **请求参数**:
  ```json
  {
    "oldPassword": "旧密码",
    "newPassword": "新密码"
  }
  ```
- **响应数据**:
  ```json
  {
    "code": 200,
    "message": "密码修改成功",
    "data": null
  }
  ```

#### 1.4 系统初始化

##### 1.4.1 初始化管理员账号
- **接口**: `POST /api/v1/users/init-admin`
- **描述**: 初始化默认管理员账号（用户名: admin, 密码: admin123）
- **认证**: 无需认证
- **响应数据**: 返回管理员用户信息

#### 1.5 认证机制说明

##### JWT Token 使用
- **获取方式**: 用户登录成功后返回
- **使用方式**: 在请求头中添加 `Authorization: Bearer {token}`
- **有效期**: 默认1小时（3600秒）
- **验证失败**: 返回401状态码

##### 权限控制
- **普通用户**: 可以访问个人相关接口
- **管理员用户**: 可以访问所有用户管理接口
- **管理员判断**: 通过用户的role字段是否为'admin'来判断

---

### 模块2：公开论文库

#### 2.1 论文浏览（所有用户）
- **获取公开论文列表**：支持分页、关键词搜索（标题、作者、标签）、筛选（年份、文章类型、分区等），返回论文列表及每篇论文是否已在当前用户的个人库中
- **获取论文详情**：返回完整的论文内容，包括元数据、摘要、关键词、章节内容、参考文献、附件信息和解析状态

#### 2.2 论文管理（仅管理员）
- **上传公开论文**：上传Markdown文件及部分元数据，创建公开论文记录，初始化解析状态为pending，异步调用大模型API进行解析
- **查询解析进度**：实时查询某篇论文的解析状态、进度百分比和当前解析阶段描述
- **编辑论文元数据**：修改论文的标题、作者、出版信息等元数据
- **编辑Block内容**：修改特定Block的内容（段落文字、公式、图片属性等）
- **添加新Block**：在指定章节中插入新的Block
- **删除Block**：移除指定的Block
- **删除论文**：删除公开论文及其相关的所有用户关联记录和笔记

---

### 模块3：个人论文库

#### 3.1 论文管理
- **查看个人论文库**：获取用户添加的所有论文（包括从公开库添加的和自己上传的私有论文），返回论文信息及个性化数据（阅读状态、优先级、备注、阅读进度等），支持按状态和优先级筛选
- **添加公开论文**：将公开论文库中的某篇论文添加到个人库，创建用户-论文关联记录
- **上传私有论文**：上传Markdown文件及元数据，创建仅自己可见的私有论文，自动添加到个人库，异步进行解析
- **更新个性化数据**：修改某篇论文的阅读状态、优先级、个人备注、阅读位置、阅读时长等信息
- **从个人库移除论文**：删除用户-论文关联记录，不影响论文本体

#### 3.2 编辑私有论文（仅限自己创建的）
- **编辑元数据**：修改私有论文的元数据
- **编辑Block内容**：修改私有论文中的Block
- **添加新Block**：在私有论文中添加Block
- **删除Block**：从私有论文中删除Block
- **删除私有论文**：彻底删除私有论文本体，同时级联删除关联记录和相关笔记

---

### 模块4：清单系统

#### 4.1 清单管理
- **创建清单**：用户创建清单，设置名称和描述（如"时间序列-缺陷检测"）
- **编辑清单**：修改清单名称和描述
- **删除清单**：删除清单，级联删除清单项目和相关笔记
- **获取用户清单列表**：返回用户的所有清单

#### 4.2 清单项目管理
- **添加论文到清单**：从个人论文库中选择论文添加到指定清单
- **从清单移除论文**：删除清单项目，不影响论文本身
- **调整清单项目顺序**：修改论文在清单中的排序
- **获取清单详情**：返回清单信息及包含的论文列表

#### 4.3 清单笔记
- **创建清单笔记**：为清单中的某篇论文创建笔记，描述该论文与清单的关系
- **编辑清单笔记**：修改笔记内容和标签
- **删除清单笔记**：删除指定笔记
- **查看清单笔记**：获取指定清单的所有笔记，按论文分组显示

---

### 模块5：笔记系统

#### 5.1 Block笔记管理
- **创建Block笔记**：为个人论文库中论文的某个Block创建笔记，输入笔记内容和可选标签
- **编辑Block笔记**：修改笔记内容或标签
- **删除Block笔记**：删除指定笔记
- **查看论文Block笔记**：获取当前用户在某篇论文下的所有Block笔记列表

#### 5.2 笔记查询
- **查看所有Block笔记**：获取当前用户的所有Block笔记（跨论文），支持分页，包含笔记所属论文的基本信息
- **按标签筛选笔记**：根据标签过滤笔记
- **搜索笔记内容**：根据关键词搜索笔记内容

---

### 模块6：文件管理

#### 6.1 图片文件
- **上传图片**：接收图片文件，保存到本地uploads/images目录，返回访问URL路径
- **获取图片**：根据文件名返回图片文件流

#### 6.2 文档文件
- **上传Markdown文件**：保存Markdown文件到本地uploads/markdown目录，返回文件路径
- **上传PDF文件**：保存PDF文件到本地uploads/pdf目录，返回文件路径

---

## 五、权限控制

### 5.1 管理员判断
通过用户的role字段是否为'admin'来判断是否为管理员

### 5.2 论文权限
- **查看权限**：公开论文所有用户可见；私有论文仅创建者可见
- **编辑权限**：管理员可编辑公开论文；用户可编辑自己创建的私有论文
- **删除权限**：管理员可删除公开论文；用户可删除自己创建的私有论文

### 5.3 个人论文库权限
- **访问权限**：用户只能管理自己的个人论文库
- **添加权限**：用户可以添加公开论文到个人库，可以上传私有论文

### 5.4 清单权限
- **访问权限**：用户只能管理自己的清单
- **论文限制**：只能将个人论文库中的论文添加到清单

### 5.5 笔记权限
- **Block笔记**：用户只能为已添加到个人库的论文创建Block笔记
- **Block验证**：创建笔记时需验证blockId是否存在于该论文中
- **清单笔记**：用户只能为自己的清单创建笔记
- **笔记操作**：用户只能编辑和删除自己的笔记

---

## 六、业务规则

### 6.1 级联删除
- **删除论文时**：同时删除所有用户与该论文的关联记录（UserPaper）以及所有相关Block笔记
- **删除用户时**：删除用户创建的所有私有论文（及其级联数据）、删除该用户的所有关联记录、所有笔记和所有清单
- **删除清单时**：删除清单项目和相关清单笔记，不影响论文本身

### 6.2 Markdown解析流程
- **上传阶段**：保存Markdown文件，创建Paper记录，设置parseStatus为pending状态（进度0%），如果是私有论文则创建UserPaper关联
- **解析阶段**：异步调用大模型API，实时更新解析进度和状态描述（如"正在解析文档结构"、"正在解析章节内容"等）
- **完成阶段**：解析成功后将sections、references、abstract、keywords等数据写入Paper记录，状态改为completed（进度100%）
- **失败处理**：解析失败时记录错误信息到parseStatus.message，状态改为failed

### 6.3 个人库关联规则
- 从公开库添加论文时，只创建UserPaper关联记录，不复制论文本体
- 用户上传私有论文时，创建Paper记录（isPublic=false）同时创建UserPaper关联
- 从个人库移除论文时，只删除UserPaper记录，不删除论文本体（除非是删除私有论文本体的操作）

### 6.4 清单管理规则
- 清单是用户创建的论文分类工具，不影响论文本身的存在
- 只能将个人论文库中的论文添加到清单
- 删除清单时，论文仍然保留在个人库中
- 清单笔记用于描述论文与清单的特定关系

### 6.5 笔记关联规则
- Block笔记必须关联到个人论文库中的论文Block
- 清单笔记必须关联到用户的清单和其中的论文
- 删除论文时，级联删除相关Block笔记
- 删除清单时，级联删除相关清单笔记

---

## 七、开发顺序

### 第一阶段：基础框架（已完成）
- FastAPI项目初始化、目录结构搭建
- MongoDB连接配置
- 工具函数封装（ID生成、日期处理、响应格式等）

### 第二阶段：用户系统（已完成）
- User模型和数据库操作
- JWT认证中间件
- 登录、登出、获取用户信息接口
- 管理员创建用户接口

### 第三阶段：公开论文库（已完成）
- Paper模型和完整数据结构
- 公开论文列表接口（分页、搜索、筛选）
- 论文详情接口
- 管理员上传Markdown接口
- Markdown解析（调用大模型API）
- 解析进度查询接口

### 第四阶段：个人论文库（待开发）
- UserPaper模型
- 个人论文库列表接口
- 添加公开论文到个人库
- 上传私有论文接口
- 更新个性化数据接口
- 从个人库移除论文

### 第五阶段：论文编辑（待开发）
- 权限验证中间件
- 元数据编辑接口
- Block增删改接口
- 论文删除接口（实现级联删除）

### 第六阶段：清单系统（待开发）
- Checklist模型和ChecklistItem模型
- 清单增删改查接口
- 清单项目管理接口
- 清单笔记功能

### 第七阶段：笔记系统（待开发）
- Note模型
- Block笔记增删改查接口
- 笔记列表查询（单论文和全部笔记）
- 笔记创建时的验证逻辑

### 第八阶段：文件管理（待开发）
- 图片上传和获取接口
- Markdown文件保存
- PDF文件上传
